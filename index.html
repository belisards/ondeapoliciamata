	<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Violência Policial,Autos de Resistência,Rio de Janeiro,Polícia Militar">
    <meta name="author" content="Adriano Belisário - @belisards">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link href="style.css" rel="stylesheet">

    <title>Onde a Polícia Mata?</title>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300" type="text/css" />

  </head>
  
  <body>
    <header>
        <img src="logo.png" alt ="Onde a Polícia Mata?" class="center"></img>

     <h3>Homicídios decorrentes de intervenção policial no Rio de Janeiro <a class="expand" href="#">[ + ]</a></h3>
    </header>

  	<div class="columnsContainer">

	  	<div class="leftColumn">
                    <div id="map">
                    </div>
	  	</div>

	  	<div class="rightColumn">
	  	    <div class="sliderContainer">



        <h4>SELECIONE O ANO:</h4>
            <input id="timeslide" type="range" min="0" max="7" value="7" step="1"/><br>
            <span id="range">2017</span>
        </div>
   <ul class="legend">
            <br />
            <li><span class="zero"></span> Sem homicídios</li><br />
            <li><span class="grau1"></span> Entre 1 e 36</li><br />
            <li><span class="grau2"></span> Entre 36 e 100</li><br />
            <li><span class="grau3"></span> Mais de 100</li><br />
        </ul>

                <div class="dados">
                    </div>
    
        </div>

           

	  	</div>

  	</div>
    
    <footer>

        <p>Realização: <a href="https://global.org.br/" target="_blank">Justiça Global</a> | Desenvolvimento em <a href="https://github.com/belisards/ondeapoliciamata/" target="_blank">código-aberto</a> por <a href="https://twitter.com/belisards/"" target="_blank">Adriano Belisário</a></p>
  	</footer>

  </body>
</html>


<script>  

// Setup inicial
var width = 900,
    height = 400,
    centered;

const zoom = d3.zoom()
      .scaleExtent([1/4, 9])
      .on('zoom', function () {
        d3.select('g').attr('transform', d3.event.transform)
      });

var inputValue = null;
var time = ["2010","2011","2012","2013","2014", "2015", "2016", "2017"];


var projection = d3.geoMercator()
    .translate([width / 2, height / 2])
    .scale((width - 1) / 2 / Math.PI);


var path = d3.geoPath().projection(projection);


var svg = d3.select("#map")
    .append("svg")
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "0 0 900 400")
    .classed("svg-content-responsive", true)
    .call(zoom)
    ;


var tooltip = d3.select('#map').append('div')
              .attr('class', 'hidden tooltip');

/// Começa a desenhar o mapa
var g = svg.append("g");

d3.json("autoresistenciario.json", function(error, aisp) {

        projection.fitSize([width,height], topojson.feature(aisp, aisp.objects.LIMITE_AISP));
        
          g.attr("class", "regiao")
          .selectAll("path")
          .data(topojson.feature(aisp, aisp.objects.LIMITE_AISP).features)
          .enter().append("path")
          .attr( "fill", initialState )
          .attr("d", path) 
          .on('mousemove', mousemoved)
          .on('mouseover', tipMouseOver) 
          .on('mouseout', tipMouseOut)
          .on('mouseout', mousegone)
          .on('click', clicked)
      }); 


// tooltip superior

tipMouseOver = function(d, i) {
        d3.select(".dados").html("<h4><b>" + d.properties.AISP + "° batalhão</b></h4>" 
                               + "2010: " + d.properties.dez+ "<br>2011: " +  d.properties.onze + "<br>2012: " +  d.properties.doze + "<br>2013: " +  d.properties.treze + "<br>2014: " +  d.properties.catorze + "<br>2015: " +  d.properties.quinze + "<br>2016: " +  d.properties.dezesseis + "<br>2017: " +  d.properties.dezesete 
                               );                   
      }

 var tipMouseOut = function(d) {
                  d3.select(".dados").style("opacity", 0); // 
};

/// fim tooltip

/// Funções que lidam com a tooltip ao mover o mouse
  function mousemoved(d) {
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (d3.event.clientX + 5) + 'px; top:' + (d3.event.clientY - 5) + 'px')
            .html("<b>Bairros</b>: " +  d.properties.bairros + "<br><br><b>Total (2010-17)</b>:<p class='total'>" + d.properties.Total + "</p>"
                               );
        }

  function mousegone() {
    d3.select(".tooltip").style("opacity", 0); // 
            tooltip.classed('hidden', true);
}



/// Zoom no click
function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(1500)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
  }
/// Fim do Zoom




// Atualiza as cores quando move o filtro 
    d3.select("#timeslide").on("input", function() {
        update(+this.value);
    });

    function update(value) {
        document.getElementById("range").innerHTML=time[value];
        inputValue = time[value];
        d3.selectAll("path")
            .style("fill", timeMatch)
            ;
    }

    function timeMatch(aisp) {
        if (inputValue == "2010") {
              if (aisp.properties.dez < "1") {
                return 'gray'
            }
            if (aisp.properties.dez > "0" && aisp.properties.dez < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.dez > "35" && aisp.properties.dez < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.dez > "99") {
                return 'red'
            }
             else {
                return 'black'
            }

        } else if (inputValue == "2011") {

          if (aisp.properties.onze < "1") {
                return 'gray'
            }
            if (aisp.properties.onze > "0" && aisp.properties.onze < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.onze > "35" && aisp.properties.onze < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.onze > "99") {
                return 'red'
            }
             else {
                return 'black'
            }

        } else if (inputValue == "2012") {
            
            if (aisp.properties.doze < "1") {
                return 'gray'
            }
            if (aisp.properties.doze > "0" && aisp.properties.doze < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.doze > "35" && aisp.properties.doze < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.doze > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        } 
 else if (inputValue == "2013") {
            
            if (aisp.properties.treze < "1") {
                return 'gray'
            }
            if (aisp.properties.treze > "0" && aisp.properties.treze < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.treze > "35" && aisp.properties.treze < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.treze > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        }
        else if (inputValue == "2014") {
            
            if (aisp.properties.catorze < "1") {
                return 'gray'
            }
            if (aisp.properties.catorze > "0" && aisp.properties.catorze < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.catorze > "35" && aisp.properties.catorze < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.catorze > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        }
      else if (inputValue == "2015") {
            
            if (aisp.properties.quinze < "1") {
                return 'gray'
            }
            if (aisp.properties.quinze > "0" && aisp.properties.quinze < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.quinze > "35" && aisp.properties.quinze < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.quinze > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        }

        else if (inputValue == "2016") {
            
            if (aisp.properties.dezesseis < "1") {
                return 'gray'
            }
            if (aisp.properties.dezesseis > "0" && aisp.properties.dezesseis < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.dezesseis > "35" && aisp.properties.dezesseis < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.dezesseis > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        }
else if (inputValue == "2017") {
            
            if (aisp.properties.dezesete < "1") {
                return 'gray'
            }
            if (aisp.properties.dezesete > "0" && aisp.properties.dezesete < "36") {
                return '#fdcc8a'
            }
            if (aisp.properties.dezesete > "35" && aisp.properties.dezesete < "100") {
                return '#fc8d59'
            }
             if (aisp.properties.dezesete > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        }



        ;
    }

// Define valor padrão do timeslider
    function initialState(data){
        if (document.getElementById("range").innerHTML == 2017) {
            if (data.properties.dezesete < "1") {
                return 'gray'
            }
            if (data.properties.dezesete > "0" && data.properties.dezesete < "36") {
                return '#fdcc8a'
            }
            if (data.properties.dezesete > "35" && data.properties.dezesete < "100") {
                return '#fc8d59'
            }
             if (data.properties.dezesete > "99") {
                return 'red'
            }
             else {
                return 'black'
            }
        };
}
</script>